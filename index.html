<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>6-Minute Walk Test</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
      line-height: 1.4;
    }

    .app {
      max-width: 560px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 16px 16px 24px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      font-size: 12px;
      color: #777;
      margin-bottom: 12px;
    }

    .section-title {
      margin-top: 18px;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 600;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      font-size: 12px;
    }

    .info-grid label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    input {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 12px;
      box-sizing: border-box;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-bottom: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 5px;
      text-align: center;
    }

    th {
      background: #fafafa;
      font-weight: 600;
    }

    .timer-display {
      font-size: 40px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 10px;
    }

    .btn-row {
      text-align: center;
      margin-bottom: 6px;
    }

    .btn-row-main {
      margin-bottom: 10px;
    }

    .btn-row-exercise {
      margin-bottom: 6px;
    }

    button {
      padding: 8px 10px;
      border: none;
      border-radius: 999px;
      margin: 0 3px 4px;
      color: #fff;
      min-width: 80px;
      font-size: 13px;
    }

    .btn-start { background: #4caf50; }
    .btn-pause { background: #ff9800; }
    .btn-reset { background: #f44336; }
    .btn-lap   { background: #2196f3; }
    .btn-stop-start { background: #9c27b0; }
    .btn-stop-end   { background: #795548; }

    .active-minute {
      background: #e3f2fd !important;
    }
  </style>
</head>
<body>

<div class="app">

  <h1>6-Minute Walk Test</h1>
  <div class="subtitle">Trial 1 & Trial 2 · Mobile Optimized</div>

  <!-- Patient Info：只保留 Name -->
  <div class="section-title">Patient Info</div>
  <div class="info-grid">
    <label>Name
      <input type="text">
    </label>
  </div>

  <!-- Timer -->
  <div class="section-title">Timer</div>
  <div id="timer" class="timer-display">00:00</div>

  <!-- Timer 控制按钮：Start + Reset -->
  <div class="btn-row btn-row-main">
    <button id="startBtn" class="btn-start">Start</button>
    <button id="resetBtn" class="btn-reset">Reset</button>
  </div>

  <!-- At Rest -->
  <div class="section-title">At Rest</div>
  <table>
    <thead>
      <tr>
        <th>Trial</th>
        <th>SpO₂</th>
        <th>PR</th>
        <th>BP</th>
        <th>Borg</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Trial 1</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric" class="bp-input" placeholder="120/80"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr>
        <td>Trial 2</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric" class="bp-input" placeholder="120/80"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
    </tbody>
  </table>

  <!-- Exercise -->
  <div class="section-title">Exercise (Minute 1–6)</div>

  <!-- 与 Exercise 一起使用的控制按钮：Pause / Lap / Stop -->
  <div class="btn-row btn-row-exercise">
    <button id="pauseBtn" class="btn-pause">Pause</button>
    <button id="lapBtn" class="btn-lap">Lap 30m</button>
    <button id="stopStartBtn" class="btn-stop-start">Start Stop</button>
    <button id="stopEndBtn" class="btn-stop-end" disabled>End Stop</button>
  </div>

  <table>
    <thead>
      <tr>
        <th rowspan="2">Min</th>
        <th colspan="3">Trial 1</th>
        <th colspan="3">Trial 2</th>
      </tr>
      <tr>
        <th>SpO₂</th><th>PR</th><th>Borg</th>
        <th>SpO₂</th><th>PR</th><th>Borg</th>
      </tr>
    </thead>

    <tbody id="exerciseBody">
      <tr data-minute="1">
        <td>1</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr data-minute="2">
        <td>2</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
       <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr data-minute="3">
        <td>3</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr data-minute="4">
        <td>4</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr data-minute="5">
        <td>5</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr data-minute="6">
        <td>6</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
    </tbody>
  </table>

  <!-- Recovery -->
  <div class="section-title">Recovery</div>
  <table>
    <thead>
      <tr>
        <th>Trial</th>
        <th>SpO₂</th>
        <th>PR</th>
        <th>BP</th>
        <th>Borg</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Trial 1</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric" class="bp-input" placeholder="120/80"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr>
        <td>Trial 2</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric" class="bp-input" placeholder="120/80"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
    </tbody>
  </table>

  <!-- Total distance -->
  <div class="section-title">Total Distance</div>
  <table>
    <thead>
      <tr>
        <th></th>
        <th>Trial 1 (m)</th>
        <th>Trial 2 (m)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Total</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
    </tbody>
  </table>

  <!-- Lap summary -->
  <div id="lapInfo" style="
      text-align:center;
      margin-top:4px;
      font-size:13px;
      font-weight:600;">
    Laps: 0 · Distance: 0 m (30 m per lap)
  </div>

  <!-- Stops table -->
  <div class="section-title">Stops During Test</div>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Start</th>
        <th>End</th>
        <th>Duration</th>
        <th>Borg</th>
      </tr>
    </thead>
    <tbody id="stopsBody">
      <!-- 动态添加 -->
    </tbody>
  </table>
  <div id="stopsSummary" style="
      text-align:center;
      font-size:12px;
      color:#555;">
    No stops recorded.
  </div>

</div>

<script>
  const DURATION = 6 * 60;
  let elapsed = 0;
  let running = false;
  let timerId = null;

  let laps = 0;

  let stopActive = false;
  let stopStartSec = 0;
  let totalStopSeconds = 0;

  const timerEl = document.getElementById("timer");
  const exerciseBody = document.getElementById("exerciseBody");
  const lapInfoEl = document.getElementById("lapInfo");
  const lapBtn = document.getElementById("lapBtn");

  const stopStartBtn = document.getElementById("stopStartBtn");
  const stopEndBtn   = document.getElementById("stopEndBtn");
  const stopsBody    = document.getElementById("stopsBody");
  const stopsSummaryEl = document.getElementById("stopsSummary");

  function format(sec) {
    const m = String(Math.floor(sec / 60)).padStart(2,'0');
    const s = String(sec % 60).padStart(2,'0');
    return `${m}:${s}`;
  }

  function updateTimer() {
    timerEl.textContent = format(elapsed);
  }

  function highlight() {
    exerciseBody.querySelectorAll("tr").forEach(r =>
      r.classList.remove("active-minute")
    );

    if (elapsed === 0) return;
    let minute = Math.floor((elapsed - 1) / 60) + 1;
    if (minute > 6) minute = 6;

    const row = exerciseBody.querySelector(`tr[data-minute="${minute}"]`);
    if (row) row.classList.add("active-minute");
  }

  function updateLapDisplay() {
    const dist = laps * 30;
    lapInfoEl.textContent = `Laps: ${laps} · Distance: ${dist} m (30 m per lap)`;
  }

  function updateStopsSummary() {
    const n = stopsBody.children.length;
    if (n === 0) {
      stopsSummaryEl.textContent = "No stops recorded.";
    } else {
      stopsSummaryEl.textContent =
        `Stops: ${n} · Total stopped time: ${format(totalStopSeconds)}`;
    }
  }

  function addStopRow(startSec, endSec, durationSec) {
    const idx = stopsBody.children.length + 1;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${idx}</td>
      <td>${format(startSec)}</td>
      <td>${format(endSec)}</td>
      <td>${format(durationSec)}</td>
      <td><input type="text" inputmode="numeric"></td>
    `;
    stopsBody.appendChild(tr);
  }

  function closeCurrentStop(endTimeSec) {
    if (!stopActive) return;
    stopActive = false;
    stopEndBtn.disabled = true;
    stopStartBtn.disabled = false;

    const end = endTimeSec;
    const dur = Math.max(0, end - stopStartSec);
    totalStopSeconds += dur;
    addStopRow(stopStartSec, end, dur);
    updateStopsSummary();
  }

  function startTimer(){
    if (running || elapsed >= DURATION) return;
    running = true;

    timerId = setInterval(()=>{
      elapsed++;
      if (elapsed >= DURATION) elapsed = DURATION;

      updateTimer();
      highlight();

      if (elapsed >= DURATION){
        if (stopActive) {
          closeCurrentStop(DURATION);
        }
        clearInterval(timerId);
        running = false;
        alert("6 分钟结束");
      }
    },1000);
  }

  function pauseTimer(){
    running = false;
    clearInterval(timerId);
  }

  function resetTimer(){
    running = false;
    clearInterval(timerId);
    elapsed = 0;
    updateTimer();
    exerciseBody.querySelectorAll("tr").forEach(r =>
      r.classList.remove("active-minute")
    );
    laps = 0;
    updateLapDisplay();

    // reset stops
    stopActive = false;
    stopStartSec = 0;
    totalStopSeconds = 0;
    stopsBody.innerHTML = "";
    updateStopsSummary();
    stopStartBtn.disabled = false;
    stopEndBtn.disabled = true;
  }

  document.getElementById("startBtn").onclick = startTimer;
  document.getElementById("pauseBtn").onclick = pauseTimer;
  document.getElementById("resetBtn").onclick = resetTimer;

  // Lap 按钮：只更新文字
  lapBtn.onclick = function () {
    laps++;
    updateLapDisplay();
  };

  // Stop 功能
  stopStartBtn.onclick = function () {
    if (stopActive) return;
    stopActive = true;
    stopStartSec = elapsed;
    stopStartBtn.disabled = true;
    stopEndBtn.disabled = false;
  };

  stopEndBtn.onclick = function () {
    if (!stopActive) return;
    closeCurrentStop(elapsed);
  };

  // BP 自动插入 "/"：例如 12080 → 120/80
  const bpInputs = document.querySelectorAll('.bp-input');
  bpInputs.forEach(input => {
    input.addEventListener('<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>6-Minute Walk Test</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
      line-height: 1.4;
    }

    .app {
      max-width: 560px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 16px 16px 24px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      font-size: 12px;
      color: #777;
      margin-bottom: 12px;
    }

    .section-title {
      margin-top: 18px;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 600;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      font-size: 12px;
    }

    .info-grid label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    input {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 12px;
      box-sizing: border-box;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-bottom: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 5px;
      text-align: center;
    }

    th {
      background: #fafafa;
      font-weight: 600;
    }

    .timer-display {
      font-size: 40px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 10px;
    }

    .btn-row {
      text-align: center;
      margin-bottom: 6px;
    }

    .btn-row-main {
      margin-bottom: 10px;
    }

    .btn-row-exercise {
      margin-bottom: 6px;
    }

    button {
      padding: 8px 10px;
      border: none;
      border-radius: 999px;
      margin: 0 3px 4px;
      color: #fff;
      min-width: 80px;
      font-size: 13px;
    }

    .btn-start { background: #4caf50; }
    .btn-pause { background: #ff9800; }
    .btn-reset { background: #f44336; }
    .btn-lap   { background: #2196f3; }
    .btn-stop-start { background: #9c27b0; }
    .btn-stop-end   { background: #795548; }

    .active-minute {
      background: #e3f2fd !important;
    }
  </style>
</head>
<body>

<div class="app">

  <h1>6-Minute Walk Test</h1>
  <div class="subtitle">Trial 1 & Trial 2 · Mobile Optimized</div>

  <!-- Patient Info：只保留 Name -->
  <div class="section-title">Patient Info</div>
  <div class="info-grid">
    <label>Name
      <input type="text">
    </label>
  </div>

  <!-- Timer -->
  <div class="section-title">Timer</div>
  <div id="timer" class="timer-display">00:00</div>

  <!-- Timer 控制按钮：Start + Reset -->
  <div class="btn-row btn-row-main">
    <button id="startBtn" class="btn-start">Start</button>
    <button id="resetBtn" class="btn-reset">Reset</button>
  </div>

  <!-- At Rest -->
  <div class="section-title">At Rest</div>
  <table>
    <thead>
      <tr>
        <th>Trial</th>
        <th>SpO₂</th>
        <th>PR</th>
        <th>BP</th>
        <th>Borg</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Trial 1</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric" class="bp-input" placeholder="120/80"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr>
        <td>Trial 2</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric" class="bp-input" placeholder="120/80"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
    </tbody>
  </table>

  <!-- Exercise -->
  <div class="section-title">Exercise (Minute 1–6)</div>

  <!-- 与 Exercise 一起使用的控制按钮：Pause / Lap / Stop -->
  <div class="btn-row btn-row-exercise">
    <button id="pauseBtn" class="btn-pause">Pause</button>
    <button id="lapBtn" class="btn-lap">Lap 30m</button>
    <button id="stopStartBtn" class="btn-stop-start">Start Stop</button>
    <button id="stopEndBtn" class="btn-stop-end" disabled>End Stop</button>
  </div>

  <table>
    <thead>
      <tr>
        <th rowspan="2">Min</th>
        <th colspan="3">Trial 1</th>
        <th colspan="3">Trial 2</th>
      </tr>
      <tr>
        <th>SpO₂</th><th>PR</th><th>Borg</th>
        <th>SpO₂</th><th>PR</th><th>Borg</th>
      </tr>
    </thead>

    <tbody id="exerciseBody">
      <tr data-minute="1">
        <td>1</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr data-minute="2">
        <td>2</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr data-minute="3">
        <td>3</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr data-minute="4">
        <td>4</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr data-minute="5">
        <td>5</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr data-minute="6">
        <td>6</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
    </tbody>
  </table>

  <!-- Recovery -->
  <div class="section-title">Recovery</div>
  <table>
    <thead>
      <tr>
        <th>Trial</th>
        <th>SpO₂</th>
        <th>PR</th>
        <th>BP</th>
        <th>Borg</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Trial 1</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric" class="bp-input" placeholder="120/80"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
      <tr>
        <td>Trial 2</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric" class="bp-input" placeholder="120/80"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
    </tbody>
  </table>

  <!-- Total distance -->
  <div class="section-title">Total Distance</div>
  <table>
    <thead>
      <tr>
        <th></th>
        <th>Trial 1 (m)</th>
        <th>Trial 2 (m)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Total</td>
        <td><input type="text" inputmode="numeric"></td>
        <td><input type="text" inputmode="numeric"></td>
      </tr>
    </tbody>
  </table>

  <!-- Lap summary -->
  <div id="lapInfo" style="
      text-align:center;
      margin-top:4px;
      font-size:13px;
      font-weight:600;">
    Laps: 0 · Distance: 0 m (30 m per lap)
  </div>

  <!-- Stops table -->
  <div class="section-title">Stops During Test</div>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Start</th>
        <th>End</th>
        <th>Duration</th>
        <th>Borg</th>
      </tr>
    </thead>
    <tbody id="stopsBody">
      <!-- 动态添加 -->
    </tbody>
  </table>
  <div id="stopsSummary" style="
      text-align:center;
      font-size:12px;
      color:#555;">
    No stops recorded.
  </div>

</div>

<script>
  const DURATION = 6 * 60;
  let elapsed = 0;
  let running = false;
  let timerId = null;

  let laps = 0;

  let stopActive = false;
  let stopStartSec = 0;
  let totalStopSeconds = 0;

  const timerEl = document.getElementById("timer");
  const exerciseBody = document.getElementById("exerciseBody");
  const lapInfoEl = document.getElementById("lapInfo");
  const lapBtn = document.getElementById("lapBtn");

  const stopStartBtn = document.getElementById("stopStartBtn");
  const stopEndBtn   = document.getElementById("stopEndBtn");
  const stopsBody    = document.getElementById("stopsBody");
  const stopsSummaryEl = document.getElementById("stopsSummary");

  function format(sec) {
    const m = String(Math.floor(sec / 60)).padStart(2,'0');
    const s = String(sec % 60).padStart(2,'0');
    return `${m}:${s}`;
  }

  function updateTimer() {
    timerEl.textContent = format(elapsed);
  }

  function highlight() {
    exerciseBody.querySelectorAll("tr").forEach(r =>
      r.classList.remove("active-minute")
    );

    if (elapsed === 0) return;
    let minute = Math.floor((elapsed - 1) / 60) + 1;
    if (minute > 6) minute = 6;

    const row = exerciseBody.querySelector(`tr[data-minute="${minute}"]`);
    if (row) row.classList.add("active-minute");
  }

  function updateLapDisplay() {
    const dist = laps * 30;
    lapInfoEl.textContent = `Laps: ${laps} · Distance: ${dist} m (30 m per lap)`;
  }

  function updateStopsSummary() {
    const n = stopsBody.children.length;
    if (n === 0) {
      stopsSummaryEl.textContent = "No stops recorded.";
    } else {
      stopsSummaryEl.textContent =
        `Stops: ${n} · Total stopped time: ${format(totalStopSeconds)}`;
    }
  }

  function addStopRow(startSec, endSec, durationSec) {
    const idx = stopsBody.children.length + 1;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${idx}</td>
      <td>${format(startSec)}</td>
      <td>${format(endSec)}</td>
      <td>${format(durationSec)}</td>
      <td><input type="text" inputmode="numeric"></td>
    `;
    stopsBody.appendChild(tr);
  }

  function closeCurrentStop(endTimeSec) {
    if (!stopActive) return;
    stopActive = false;
    stopEndBtn.disabled = true;
    stopStartBtn.disabled = false;

    const end = endTimeSec;
    const dur = Math.max(0, end - stopStartSec);
    totalStopSeconds += dur;
    addStopRow(stopStartSec, end, dur);
    updateStopsSummary();
  }

  function startTimer(){
    if (running || elapsed >= DURATION) return;
    running = true;

    timerId = setInterval(()=>{
      elapsed++;
      if (elapsed >= DURATION) elapsed = DURATION;

      updateTimer();
      highlight();

      if (elapsed >= DURATION){
        if (stopActive) {
          closeCurrentStop(DURATION);
        }
        clearInterval(timerId);
        running = false;
        alert("6 分钟结束");
      }
    },1000);
  }

  function pauseTimer(){
    running = false;
    clearInterval(timerId);
  }

  function resetTimer(){
    running = false;
    clearInterval(timerId);
    elapsed = 0;
    updateTimer();
    exerciseBody.querySelectorAll("tr").forEach(r =>
      r.classList.remove("active-minute")
    );
    laps = 0;
    updateLapDisplay();

    // reset stops
    stopActive = false;
    stopStartSec = 0;
    totalStopSeconds = 0;
    stopsBody.innerHTML = "";
    updateStopsSummary();
    stopStartBtn.disabled = false;
    stopEndBtn.disabled = true;
  }

  document.getElementById("startBtn").onclick = startTimer;
  document.getElementById("pauseBtn").onclick = pauseTimer;
  document.getElementById("resetBtn").onclick = resetTimer;

  // Lap 按钮：只更新文字
  lapBtn.onclick = function () {
    laps++;
    updateLapDisplay();
  };

  // Stop 功能
  stopStartBtn.onclick = function () {
    if (stopActive) return;
    stopActive = true;
    stopStartSec = elapsed;
    stopStartBtn.disabled = true;
    stopEndBtn.disabled = false;
  };

  stopEndBtn.onclick = function () {
    if (!stopActive) return;
    closeCurrentStop(elapsed);
  };

  // BP 自动格式：支持 90/60、120/80 等
  const bpInputs = document.querySelectorAll('.bp-input');
  bpInputs.forEach(input => {
    input.addEventListener('input', function () {
      let v = this.value.replace(/[^\d]/g, ''); // 只留数字

      if (v.length >= 4) {
        if (v.length === 4) {
          // 9060 → 90/60
          this.value = v.slice(0, 2) + "/" + v.slice(2);
        } else if (v.length === 5) {
          // 12080 → 120/80
          this.value = v.slice(0, 3) + "/" + v.slice(3);
        } else {
          // 超过 5 位，裁剪再按 3+2 处理
          v = v.slice(0, 5);
          this.value = v.slice(0, 3) + "/" + v.slice(3);
        }
      } else {
        // 少于 4 位：不强制插 "/"
        this.value = v;
      }
    });
  });

  // 初始化
  updateTimer();
  updateLapDisplay();
  updateStopsSummary();
</script>

</body>
</html>
input', function () {
      let v = this.value.replace(/[^\d]/g, ''); // 只留数字
      if (v.length > 3) {
        this.value = v.slice(0, 3) + '/' + v.slice(3, 5);
      } else {
        this.value = v;
      }
    });
  });

  // 初始化
  updateTimer();
  updateLapDisplay();
  updateStopsSummary();
</script>

</body>
</html>
